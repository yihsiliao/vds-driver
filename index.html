<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>VDS å¸æ©Ÿæ‰“å¡</title>
  <style>
    /* === å…¨å±€è¨­å®š === */
    body { 
      background-color: #f4f7f6; 
      padding: 15px; 
      font-family: "Microsoft JhengHei", sans-serif; 
      color: #333; 
      min-height: 100vh; 
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      box-sizing: border-box; 
      margin: 0; 
    }

    /* å¡ç‰‡ä¸»é«” */
    .card { 
      background: white; 
      padding: 25px 20px; 
      border-radius: 24px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
      width: 100%; 
      max-width: 500px; 
      margin: 0 auto; 
      box-sizing: border-box; 
    }
    
    h3 { color: #2c3e50; text-align: center; margin: 0 0 20px 0; font-weight: 800; font-size: 22px; }
    .sub-title { font-size: 13px; color: #95a5a6; font-weight: normal; margin-top: 4px; display: block; }

    /* è¡¨å–®å…ƒä»¶ */
    label { display: block; font-weight: 700; margin-top: 15px; margin-bottom: 8px; font-size: 15px; color: #34495e; }
    
    select, input[type="text"] { 
      width: 100%; height: 55px; font-size: 18px; font-weight: 500;
      border: 2px solid #eaedf1; border-radius: 16px; background-color: #fcfcfc; padding-left: 15px;
      appearance: none; outline: none; transition: border 0.2s; box-sizing: border-box;
    }
    select { background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 10px auto; }
    select:focus, input[type="text"]:focus { border-color: #0d6efd; background-color: #fff; }
    
    #dest-label { color: #198754; } 
    #destination { border: 2px solid #d1e7dd; background-color: #f8fffb; }
    #destination:focus { border-color: #198754; }

    /* è‡ªå®šç¾©è¼¸å…¥æ¡†æ¨£å¼ */
    .custom-input { display: none; margin-top: 10px; border-color: #ffc107 !important; background-color: #fffdf5 !important; }
    
    /* è»Šç‰Œè¼¸å…¥æ¡†é è¨­å¤§å¯« */
    #plate-custom { text-transform: uppercase; }

    .radio-group { display: flex; gap: 8px; margin-top: 8px; }
    .radio-option { flex: 1; position: relative; }
    .radio-option input { position: absolute; opacity: 0; cursor: pointer; }
    .radio-content { display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f9fa; border: 2px solid transparent; border-radius: 12px; padding: 10px 0; cursor: pointer; transition: 0.2s; color: #6c757d; }
    .radio-text-main { font-size: 16px; font-weight: bold; }
    .radio-text-sub { font-size: 11px; margin-top: 2px; }
    .radio-option input:checked + .radio-content { background-color: #eef5ff; border-color: #0d6efd; color: #0d6efd; }

    .btn-row { display: flex; gap: 10px; margin-top: 25px; }
    button { flex: 1; height: 56px; border: none; border-radius: 28px; color: white; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: transform 0.1s, box-shadow 0.1s; font-family: inherit; }
    button:active { transform: scale(0.96); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .btn-text-main { font-size: 17px; font-weight: 800; line-height: 1.2; }
    .btn-text-sub { font-size: 11px; opacity: 0.9; }
    .btn-go { background: linear-gradient(135deg, #198754, #146c43); } 
    .btn-arrive { background: linear-gradient(135deg, #0d6efd, #0b5ed7); } 
    .btn-end { background: linear-gradient(135deg, #dc3545, #b02a37); width: 100%; margin-top: 12px; } 
    
    #loading-mask { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0d6efd; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #loading-text { font-size: 18px; color: #0d6efd; font-weight: bold; }

    #manual-area { display: none; margin-top: 20px; padding: 15px; background: #fff8e1; border: 2px dashed #ffc107; border-radius: 16px; text-align: center; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    #manual-btn { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 56px; background: linear-gradient(135deg, #198754, #146c43); color: white; text-decoration: none; border-radius: 28px; margin-top: 10px; box-shadow: 0 4px 10px rgba(25, 135, 84, 0.3); animation: pulse 2s infinite; }
    @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7); } 70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(25, 135, 84, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(25, 135, 84, 0); } }
    #status { text-align:center; margin-top:15px; color:#adb5bd; font-size:12px; }
  </style>
</head>
<body>

<div id="loading-mask">
  <div class="spinner"></div>
  <div id="loading-text">ç³»çµ±å•Ÿå‹•ä¸­...</div>
</div>

<div class="card">
  <h3>ğŸšš VDS å¸æ©Ÿæ‰“å¡<span class="sub-title">Há»‡ thá»‘ng cháº¥m cÃ´ng tÃ i xáº¿</span></h3>
  
  <label>ğŸ‘¤ å¸æ©Ÿå§“å <span>(TÃªn tÃ i xáº¿)</span></label>
  <select id="driver" onchange="checkCustomInput('driver')">
    <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
    <option value="åŠ‰æ–‡ç”Ÿ">åŠ‰æ–‡ç”Ÿ (A Sanh)</option>
    <option value="é˜®è¬ç·´">é˜®è¬ç·´ (Ta Luyá»‡n)</option>
    <option value="éƒ­æ–‡çµ±">éƒ­æ–‡çµ± (VÄƒn Thá»‘ng)</option>
    <option value="æ—å† å®‡">æ—å† å®‡ (QuÃ¡n VÅ©)</option>
    <option value="é™³è¡ä»‹">é™³è¡ä»‹ (A Giá»›i)</option>
    <option value="æ¸¬è©¦">æ¸¬è©¦å“¡ (Test)</option>
    <option value="custom">âœï¸ è‡ªè¡Œè¼¸å…¥ (Nháº­p tay...)</option>
  </select>
  <input type="text" id="driver-custom" class="custom-input" placeholder="è«‹è¼¸å…¥å§“å (TÃªn)">

  <label>ğŸš› è»Šç‰Œè™Ÿç¢¼ <span>(Biá»ƒn sá»‘ xe)</span></label>
  <select id="plate" onchange="checkCustomInput('plate')">
    <option value="" disabled selected>è«‹é¸æ“‡è»Šç‰Œ...</option>
    <optgroup label="å…¬å¸è»Šè¼›">
        <option value="027-TN">027-TN</option>
        <option value="KEM-9277">KEM-9277</option>
        <option value="KER-1677">KER-1677</option>
        <option value="AAR-227">AAR-227</option>
        <option value="KEN-6977">KEN-6977</option>
    </optgroup>
    <option value="custom">âœï¸ è‡ªè¡Œè¼¸å…¥ (Nháº­p tay...)</option>
  </select>
  <input type="text" id="plate-custom" class="custom-input" placeholder="è«‹è¼¸å…¥è»Šç‰Œ (ä¾‹å¦‚ KEA-1234)">

  <label>ğŸ“ ç›®å‰åœ°é» <span>(Vá»‹ trÃ­ hiá»‡n táº¡i)</span></label>
  <select id="location" onchange="checkCustomInput('location')">
    <optgroup label="å¸¸ç”¨åœ°é»">
      <option value="å…¬å¸">ğŸ¢ å…¬å¸ (CÃ´ng ty)</option>
      <option value="ç”°é–“">ğŸŒ¾ ç”°é–“ (NgoÃ i Ä‘á»“ng)</option>
    </optgroup>
    <optgroup label="åœ°é»åˆ—è¡¨ (Danh sÃ¡ch)">
      <option value="è¾²å ´æ™ƒæ™ƒ">ğŸŒ¾ è¾²å ´æ™ƒæ™ƒ (NÃ´ng trÆ°á»ng Hoáº£ng Hoáº£ng)</option>
      <option value="é¦¬å…‰">ğŸ¥• é¦¬å…‰ (MÃ£ Quang)</option>
      <option value="ä½³ç¾">ğŸ­ ä½³ç¾ (Giai Má»¹)</option>
      <option value="å…‰æ³‰">ğŸ­ å…‰æ³‰ (Quang Tuyá»n)</option>
      <option value="ä¹…æ´¥">ğŸ­ ä¹…æ´¥ (Cá»­u TÃ¢n)</option>
      <option value="é”ç¾¤">ğŸ­ é”ç¾¤ (Äáº¡t Quáº§n)</option>
      <option value="æ·‘è²">ğŸ™ï¸ æ·‘è² (Thá»¥c Trinh)</option>
      <option value="é™³ä¿éœ–">ğŸ™ï¸ é™³ä¿éœ– (Tráº§n Lá»£i LÃ¢m)</option>
      <option value="å³æ·‘ç²">ğŸ™ï¸ å³æ·‘ç² (NgÃ´ Thá»¥c Linh)</option>      
      <option value="æ¥Šé´»éš†">ğŸ™ï¸ æ¥Šé´»éš† (DÆ°Æ¡ng Há»“ng Long)</option>
      <option value="è¥¿èº">ğŸ™ï¸ è¥¿èº (TÃ¢y Loa)</option>
      <option value="åŒ—æ–—">ğŸ™ï¸ åŒ—æ–— (Báº¯c Äáº©u)</option>
      <option value="å°ä¸­">ğŸ™ï¸ å°ä¸­ (ÄÃ i Trung)</option>
      <option value="æ–—å…­">ğŸ™ï¸ æ–—å…­ (Äáº¥u Lá»¥c)</option>
      <option value="å˜‰ç¾©">ğŸ™ï¸ å˜‰ç¾© (Gia NghÄ©a)</option>
      <option value="å…ƒé•·">ğŸ™ï¸ å…ƒé•· (NguyÃªn TrÆ°á»ng)</option>
      <option value="å°å—">ğŸ™ï¸ å°å— (ÄÃ i Nam)</option>
      <option value="æ–—å—ä¿é¤Šå» ">ğŸ”§ æ–—å—ä¿é¤Šå»  (XÆ°á»Ÿng báº£o trÃ¬ Äáº¥u Nam)</option>
      <option value="èŠ±å£‡ä¿é¤Šå» ">ğŸ”§ èŠ±å£‡ä¿é¤Šå»  (XÆ°á»Ÿng báº£o trÃ¬ Hoa ÄÃ n)</option>
      <option value="å°ä¸­æ¸¯">ğŸš¢ å°ä¸­æ¸¯ (Cáº£ng ÄÃ i Trung)</option>
      <option value="é«˜é›„æ¸¯">ğŸš¢ é«˜é›„æ¸¯ (Cáº£ng Cao HÃ¹ng)</option>
      <option value="æ–°ç¤¾ç¨®è‹—å ´">ğŸŒ± æ–°ç¤¾ç¨®è‹—å ´ (Tráº¡i giá»‘ng TÃ¢n XÃ£)</option>
    </optgroup>
    <option value="custom">âœï¸ è‡ªè¡Œè¼¸å…¥ (Nháº­p tay...)</option>
  </select>
  <input type="text" id="location-custom" class="custom-input" placeholder="è«‹è¼¸å…¥åœ°é» (Vá»‹ trÃ­)">

  <label id="dest-label">ğŸ é è¨ˆå‰å¾€ <span>(NÆ¡i Ä‘áº¿n dá»± kiáº¿n)</span></label>
  <select id="destination" onchange="checkCustomInput('destination')">
    <option value="" disabled selected>è«‹é¸æ“‡ç›®çš„åœ°...</option>
    <optgroup label="å¸¸ç”¨åœ°é»">
      <option value="å…¬å¸">ğŸ¢ å…¬å¸ (CÃ´ng ty)</option>
      <option value="ç”°é–“">ğŸŒ¾ ç”°é–“ (NgoÃ i Ä‘á»“ng)</option>
    </optgroup>
    <optgroup label="åœ°é»åˆ—è¡¨ (Danh sÃ¡ch)">
      <option value="è¾²å ´æ™ƒæ™ƒ">ğŸŒ¾ è¾²å ´æ™ƒæ™ƒ (NÃ´ng trÆ°á»ng Hoáº£ng Hoáº£ng)</option>
      <option value="é¦¬å…‰">ğŸ¥• é¦¬å…‰ (MÃ£ Quang)</option>
      <option value="ä½³ç¾">ğŸ­ ä½³ç¾ (Giai Má»¹)</option>
      <option value="å…‰æ³‰">ğŸ­ å…‰æ³‰ (Quang Tuyá»n)</option>
      <option value="ä¹…æ´¥">ğŸ­ ä¹…æ´¥ (Cá»­u TÃ¢n)</option>
      <option value="é”ç¾¤">ğŸ­ é”ç¾¤ (Äáº¡t Quáº§n)</option>
      <option value="æ·‘è²">ğŸ™ï¸ æ·‘è² (Thá»¥c Trinh)</option>
      <option value="é™³ä¿éœ–">ğŸ™ï¸ é™³ä¿éœ– (Tráº§n Lá»£i LÃ¢m)</option>
      <option value="å³æ·‘ç²">ğŸ™ï¸ å³æ·‘ç² (NgÃ´ Thá»¥c Linh)</option>      
      <option value="æ¥Šé´»éš†">ğŸ™ï¸ æ¥Šé´»éš† (DÆ°Æ¡ng Há»“ng Long)</option>
      <option value="è¥¿èº">ğŸ™ï¸ è¥¿èº (TÃ¢y Loa)</option>
      <option value="åŒ—æ–—">ğŸ™ï¸ åŒ—æ–— (Báº¯c Äáº©u)</option>
      <option value="å°ä¸­">ğŸ™ï¸ å°ä¸­ (ÄÃ i Trung)</option>
      <option value="æ–—å…­">ğŸ™ï¸ æ–—å…­ (Äáº¥u Lá»¥c)</option>
      <option value="å˜‰ç¾©">ğŸ™ï¸ å˜‰ç¾© (Gia NghÄ©a)</option>
      <option value="å…ƒé•·">ğŸ™ï¸ å…ƒé•· (NguyÃªn TrÆ°á»ng)</option>
      <option value="å°å—">ğŸ™ï¸ å°å— (ÄÃ i Nam)</option>
      <option value="æ–—å—ä¿é¤Šå» ">ğŸ”§ æ–—å—ä¿é¤Šå»  (XÆ°á»Ÿng báº£o trÃ¬ Äáº¥u Nam)</option>
      <option value="èŠ±å£‡ä¿é¤Šå» ">ğŸ”§ èŠ±å£‡ä¿é¤Šå»  (XÆ°á»Ÿng báº£o trÃ¬ Hoa ÄÃ n)</option>
      <option value="å°ä¸­æ¸¯">ğŸš¢ å°ä¸­æ¸¯ (Cáº£ng ÄÃ i Trung)</option>
      <option value="é«˜é›„æ¸¯">ğŸš¢ é«˜é›„æ¸¯ (Cáº£ng Cao HÃ¹ng)</option>
      <option value="æ–°ç¤¾ç¨®è‹—å ´">ğŸŒ± æ–°ç¤¾ç¨®è‹—å ´ (Tráº¡i giá»‘ng TÃ¢n XÃ£)</option>
    </optgroup>
    <option value="custom">âœï¸ è‡ªè¡Œè¼¸å…¥ (Nháº­p tay...)</option>
  </select>
  <input type="text" id="destination-custom" class="custom-input" placeholder="è«‹è¼¸å…¥ç›®çš„åœ° (NÆ¡i Ä‘áº¿n)">

  <label>âš™ï¸ ä½œæ¥­/è¶Ÿæ¬¡ <span>(Loáº¡i cÃ´ng viá»‡c)</span></label>
  <div class="radio-group">
    <label class="radio-option"><input type="radio" name="taskType" value="" checked><div class="radio-content"><span class="radio-text-main">å…¶ä»–</span><span class="radio-text-sub">KhÃ¡c</span></div></label>
    <label class="radio-option"><input type="radio" name="taskType" value="æ©Ÿæ¡"><div class="radio-content"><span class="radio-text-main">æ©Ÿæ¡</span><span class="radio-text-sub">MÃ¡y thu</span></div></label>
    <label class="radio-option"><input type="radio" name="taskType" value="äººæ¡"><div class="radio-content"><span class="radio-text-main">äººæ¡</span><span class="radio-text-sub">NgÆ°á»i thu</span></div></label>
  </div>

  <div class="btn-row">
    <button class="btn-go" onclick="processClick('å‡ºè»Š')"><span class="btn-text-main">ğŸš€ å‡ºç™¼/å‡ºè»Š</span><span class="btn-text-sub">Xuáº¥t phÃ¡t</span></button>
    <button class="btn-arrive" onclick="processClick('æŠµé”')"><span class="btn-text-main">ğŸ æŠµé”/å›åˆ°</span><span class="btn-text-sub">Äáº¿n nÆ¡i</span></button>
  </div>
  
  <button class="btn-end" onclick="processClick('ä½œæ¥­çµæŸ')"><span class="btn-text-main">ğŸ›‘ çµæŸä»Šæ—¥ä½œæ¥­</span><span class="btn-text-sub">Káº¿t thÃºc cÃ´ng viá»‡c</span></button>

  <div id="status">LIFF åˆå§‹åŒ–ä¸­...</div>

  <div id="manual-area">
      <div style="color: #d63384; font-weight: bold; margin-bottom:5px;">âš ï¸ è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç™¼é€</div>
      <a id="manual-btn" href="#" target="_blank"><span style="font-size:18px; font-weight:bold;">ğŸŸ¢ é»æˆ‘ç™¼é€ (Nháº¥n vÃ o Ä‘Ã¢y)</span></a>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
var LIFF_ID = "2008961063-iwAJvIC3";

// é¡¯ç¤º/éš±è—è‡ªè¨‚è¼¸å…¥æ¡†
function checkCustomInput(type) {
    var select = document.getElementById(type);
    var input = document.getElementById(type + '-custom');
    if (select.value === 'custom') {
        input.style.display = 'block';
        input.focus();
    } else {
        input.style.display = 'none';
        input.value = '';
    }
}

window.onload = function() {
  setTimeout(function() { 
      var mask = document.getElementById('loading-mask');
      if(mask) mask.style.display = 'none'; 
  }, 3000);

  // è¼‰å…¥æ­·å²ç´€éŒ„ (åŒ…å«è»Šç‰Œ)
  loadHistory('driver', 'vds_history_driver');
  loadHistory('plate', 'vds_history_plate'); // â˜… è»Šç‰Œä¹Ÿæ”¯æ´æ­·å²è¨˜éŒ„
  loadHistory('location', 'vds_history_loc');
  loadHistory('destination', 'vds_history_dest');

  liff.init({ liffId: LIFF_ID }).then(function() {
    if (!liff.isLoggedIn()) { liff.login(); return; }

    liff.getProfile().then(function(profile) {
        updateDriverSelect(profile.displayName);
        document.getElementById('loading-mask').style.display = 'none';
        document.getElementById('status').innerText = "âœ… ç³»çµ±å°±ç·’";
        document.getElementById('status').style.color = "green";
    }).catch(function() {
        document.getElementById('loading-mask').style.display = 'none';
        
        // æ¢å¾©ä¸Šæ¬¡é¸æ“‡çš„å¸æ©Ÿ
        restoreSelection('driver', 'vds_driver');
        // æ¢å¾©ä¸Šæ¬¡é¸æ“‡çš„è»Šç‰Œ
        restoreSelection('plate', 'vds_plate');
    });
  }).catch(function() {
    document.getElementById('loading-mask').style.display = 'none';
  });
};

// è¼‰å…¥æ­·å²è¨˜éŒ„åˆ°ä¸‹æ‹‰é¸å–®
function loadHistory(selectId, storageKey) {
    var history = JSON.parse(localStorage.getItem(storageKey) || '[]');
    if (history.length > 0) {
        var select = document.getElementById(selectId);
        var group = document.createElement('optgroup');
        group.label = "ğŸ•’ æœ€è¿‘è¼¸å…¥";
        history.reverse().forEach(function(item) {
            var opt = document.createElement('option');
            opt.value = item;
            opt.text = "ğŸ•’ " + item;
            group.appendChild(opt);
        });
        select.insertBefore(group, select.firstChild);
    }
}

// å„²å­˜æ–°çš„æ­·å²è¨˜éŒ„
function saveHistory(val, storageKey) {
    if(!val) return;
    var history = JSON.parse(localStorage.getItem(storageKey) || '[]');
    var index = history.indexOf(val);
    if (index > -1) { history.splice(index, 1); } // ç§»é™¤èˆŠçš„
    history.push(val); // åŠ åˆ°æœ€æ–°
    if (history.length > 5) history.shift(); // åªç•™5ç­†
    localStorage.setItem(storageKey, JSON.stringify(history));
}

// æ¢å¾©ä¸Šæ¬¡çš„é¸æ“‡ (é€šç”¨å‡½å¼)
function restoreSelection(elementId, storageKey) {
    var saved = localStorage.getItem(storageKey);
    if(saved) {
        var select = document.getElementById(elementId);
        var found = false;
        // 1. å˜—è©¦åœ¨é¸å–®ä¸­æ‰¾
        for(var i=0; i<select.options.length; i++) {
            if(select.options[i].value === saved) {
                select.selectedIndex = i;
                found = true;
                break;
            }
        }
        // 2. å¦‚æœæ²’æ‰¾åˆ° (ä»£è¡¨æ˜¯æ‰‹å‹•è¼¸å…¥çš„ï¼Œä¸”è¢«æ“ å‡ºæ­·å²è¨˜éŒ„äº†)ï¼Œé€™è£¡æš«æ™‚ä¸è™•ç†ï¼Œè®“ä½¿ç”¨è€…é‡é¸
    }
}

function updateDriverSelect(lineName) {
    var driverSelect = document.getElementById('driver');
    var savedDriver = localStorage.getItem('vds_driver'); 
    
    // 1. å„ªå…ˆä½¿ç”¨è¨˜æ†¶çš„å¸æ©Ÿ
    if (savedDriver) {
        for (var i = 0; i < driverSelect.options.length; i++) {
            if (driverSelect.options[i].value === savedDriver) {
                driverSelect.selectedIndex = i;
                console.log("å·²æ¢å¾©å¸æ©Ÿè¨˜æ†¶: " + savedDriver);
                var statusDiv = document.getElementById('status');
                if(statusDiv) statusDiv.innerHTML += " <span style='color:#198754'>(å·²è¨˜æ†¶)</span>";
                
                // â˜… é †ä¾¿æ¢å¾©è»Šç‰Œè¨˜æ†¶
                restoreSelection('plate', 'vds_plate');
                return; 
            }
        }
    }

    // 2. æ²’æœ‰è¨˜æ†¶æ‰æ¯”å° LINE åå­—
    var found = false;
    for (var i = 0; i < driverSelect.options.length; i++) {
        if (driverSelect.options[i].text.includes(lineName) || lineName.includes(driverSelect.options[i].value)) {
            driverSelect.selectedIndex = i; found = true; break;
        }
    }
    if (!found) {
        var newOpt = document.createElement("option");
        newOpt.text = lineName + " (LINE)"; newOpt.value = lineName;
        if (driverSelect.length > 0) driverSelect.add(newOpt, driverSelect.options[1]);
        else driverSelect.add(newOpt);
        driverSelect.value = lineName;
    }
    
    // ç„¡è«–å¦‚ä½•éƒ½å˜—è©¦æ¢å¾©è»Šç‰Œ
    restoreSelection('plate', 'vds_plate');
}

function processClick(action) {
  try {
    document.getElementById('loading-mask').style.display = 'flex';
    document.getElementById('manual-area').style.display = 'none';
    
    // å–å¾—è³‡æ–™ (æ”¯æ´æ‰‹å‹•è¼¸å…¥)
    var driverSelect = document.getElementById('driver');
    var driver = driverSelect.value === 'custom' ? document.getElementById('driver-custom').value : driverSelect.value;
    
    var plateSelect = document.getElementById('plate');
    var plate = plateSelect.value === 'custom' ? document.getElementById('plate-custom').value.trim().toUpperCase() : plateSelect.value;
    
    var locSelect = document.getElementById('location');
    var loc = locSelect.value === 'custom' ? document.getElementById('location-custom').value : locSelect.value;
    
    var destSelect = document.getElementById('destination');
    var dest = destSelect.value === 'custom' ? document.getElementById('destination-custom').value : destSelect.value;

    var type = "";
    var radios = document.getElementsByName('taskType');
    for (var i = 0; i < radios.length; i++) { if (radios[i].checked) { type = radios[i].value; break; } }

    // æª¢æŸ¥å¸æ©Ÿ
    if (!driver || driver.trim() === "") {
      document.getElementById('loading-mask').style.display = 'none';
      alert("è«‹é¸æ“‡æˆ–è¼¸å…¥å¸æ©Ÿå§“åï¼");
      if(driverSelect.value === 'custom') document.getElementById('driver-custom').focus();
      return;
    }
    if(driverSelect.value === 'custom') saveHistory(driver, 'vds_history_driver');
    localStorage.setItem('vds_driver', driver); // è¨˜æ†¶å¸æ©Ÿ

    // æª¢æŸ¥è»Šç‰Œ (é¸å¡«ï¼Œä½†æœ‰å¡«å°±è¨˜æ†¶)
    if (plateSelect.value === 'custom' && plate !== "") saveHistory(plate, 'vds_history_plate');
    if (plate) localStorage.setItem('vds_plate', plate); // è¨˜æ†¶è»Šç‰Œ

    // æª¢æŸ¥åœ°é» (éä½œæ¥­çµæŸæ™‚)
    if (action !== "ä½œæ¥­çµæŸ") {
        if (!loc || loc.trim() === "") {
            document.getElementById('loading-mask').style.display = 'none';
            alert("è«‹è¼¸å…¥ã€Œç›®å‰åœ°é»ã€ï¼");
            if(locSelect.value === 'custom') document.getElementById('location-custom').focus();
            return;
        }
        if(locSelect.value === 'custom') saveHistory(loc, 'vds_history_loc');
    }

    var now = new Date();
    var hh = now.getHours().toString().padStart(2, '0');
    var mm = now.getMinutes().toString().padStart(2, '0');
    var timeStr = hh + ":" + mm;
    
    // â˜… è¨Šæ¯çµ„åˆ
    var plateStr = (plate) ? "[" + plate + "] " : ""; // è»Šç‰ŒåŠ æ¡†
    var taskSuffix = (type === "") ? "" : "(" + type + ")";
    var msg = "";

    if (action === "ä½œæ¥­çµæŸ") {
      msg = plateStr + driver + " çµæŸæ™‚é–“" + timeStr;
    } else if (action === "å‡ºè»Š") {
      if (!dest || dest.trim() === "") {
          document.getElementById('loading-mask').style.display = 'none';
          alert("âš ï¸ è«‹é¸æ“‡æˆ–è¼¸å…¥ã€Œé è¨ˆå‰å¾€ã€çš„ç›®çš„åœ°ï¼");
          if(destSelect.value === 'custom') {
              document.getElementById('destination-custom').focus();
          } else {
              document.getElementById('destination').focus();
          }
          return;
      }
      if(destSelect.value === 'custom') saveHistory(dest, 'vds_history_dest');
      
      msg = plateStr + driver + " " + loc + "å‡ºç™¼å‰å¾€" + dest + taskSuffix + " " + timeStr;
    } else if (action === "æŠµé”") {
      if (loc === "å…¬å¸") { msg = plateStr + driver + " å›åˆ°å…¬å¸ " + timeStr; } 
      else { msg = plateStr + driver + " æŠµé”" + loc + " " + timeStr; }
    }

    tryAutoSend(msg);

  } catch (e) {
    alert("Error: " + e.message);
    document.getElementById('loading-mask').style.display = 'none';
  }
}

function tryAutoSend(msg) {
  if (!liff.isInClient()) { showManualButton(msg); return; }

  liff.sendMessages([{ type: 'text', text: msg }])
    .then(function() {
      document.getElementById('loading-mask').style.display = 'none';
      liff.closeWindow();
    })
    .catch(function(err) {
      if (liff.isApiAvailable('shareTargetPicker')) {
        liff.shareTargetPicker([{ type: "text", text: msg }])
          .then(function(res) {
            document.getElementById('loading-mask').style.display = 'none';
            if (res) liff.closeWindow();
          })
          .catch(function() { showManualButton(msg); });
      } else {
         showManualButton(msg);
      }
    });
}

function showManualButton(msg) {
  document.getElementById('loading-mask').style.display = 'none';
  var area = document.getElementById('manual-area');
  var btn = document.getElementById('manual-btn');
  btn.href = "https://line.me/R/msg/text/?" + encodeURIComponent(msg);
  area.style.display = 'block';
  setTimeout(function() {
      area.scrollIntoView({ behavior: "smooth", block: "center" });
  }, 100);
}
</script>
</body>
</html>