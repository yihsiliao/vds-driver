<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>ğŸ¥•VDS å¸æ©Ÿæ‰“å¡ | Cháº¥m cÃ´ng</title>
  <style>
    /* v30.0 UI Fix */
    body { background-color: #f8f9fa; padding: 15px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; color: #212529; min-height: 100vh; display: flex; flex-direction: column; justify-content: flex-start; box-sizing: border-box; margin: 0; }
    .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); width: 100%; max-width: 480px; margin: 0 auto; box-sizing: border-box; }
    
    h3 { color: #198754; text-align: center; margin: 0 0 5px 0; font-weight: 800; font-size: 24px; letter-spacing: 0.5px; }
    .sub-title { font-size: 14px; color: #6c757d; font-weight: 400; text-align: center; display: block; margin-bottom: 20px; }

    label { display: block; font-weight: 700; margin-top: 15px; margin-bottom: 6px; font-size: 16px; color: #343a40; }
    label span { font-weight: 400; color: #6c757d; font-size: 13px; margin-left: 5px; }
    
    select, input[type="text"], input[type="password"] { width: 100%; height: 50px; font-size: 17px; font-weight: 500; border: 1px solid #ced4da; border-radius: 10px; background-color: #fff; padding-left: 12px; appearance: none; outline: none; transition: border-color 0.2s; box-sizing: border-box; color: #212529; }
    select:focus, input:focus { border-color: #198754; box-shadow: 0 0 0 3px rgba(25, 135, 84, 0.1); }
    
    #dest-label { color: #198754; } 
    #destination { border: 2px solid #198754; background-color: #f0fff4; }
    .custom-input { display: none; margin-top: 8px; border-color: #ffc107 !important; background-color: #fffdf5 !important; }
    #plate-custom { text-transform: uppercase; }

    .radio-group { display: flex; gap: 8px; margin-top: 8px; }
    .radio-option { flex: 1; position: relative; }
    .radio-option input { position: absolute; opacity: 0; cursor: pointer; height: 100%; width: 100%; }
    .radio-content { display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f1f3f5; border: 1px solid #dee2e6; border-radius: 10px; padding: 10px 0; transition: 0.2s; color: #495057; }
    .radio-option input:checked + .radio-content { background-color: #e6f4ea; border-color: #198754; color: #198754; font-weight: bold; box-shadow: inset 0 0 0 1px #198754; }
    .radio-text-main { font-size: 16px; }
    .radio-text-sub { font-size: 11px; margin-top: 1px; }

    .divider { height: 1px; background: #e9ecef; margin: 20px 0 10px 0; }

    .btn-row { display: flex; gap: 10px; margin-top: 25px; }
    button { flex: 1; height: 60px; border: none; border-radius: 12px; color: white; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.1s; font-family: inherit; }
    button:active { transform: scale(0.97); }
    button:disabled { background: #ced4da !important; cursor: not-allowed; opacity: 0.7; }
    
    .btn-go { background: linear-gradient(135deg, #198754, #146c43); } 
    .btn-arrive { background: linear-gradient(135deg, #0d6efd, #0a58ca); } 
    .btn-end { background: linear-gradient(135deg, #dc3545, #b02a37); width: 100%; margin-top: 12px; } 
    .btn-text-main { font-size: 18px; font-weight: 700; line-height: 1.1; }
    .btn-text-sub { font-size: 12px; opacity: 0.9; margin-top: 2px; font-weight: 400; }

    #loading-mask { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; flex-direction: column; justify-content: center; align-items: center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #198754; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #loading-text { font-size: 16px; color: #198754; font-weight: bold; }
    #status { text-align:center; margin-top:15px; color:#adb5bd; font-size:12px; }
    
    #dashboard-toggle { text-align: center; margin-top: 20px; cursor: pointer; color: #6c757d; font-size: 13px; text-decoration: underline; padding: 10px; }
    #dashboard-panel { display: none; background: #2c3e50; border-radius: 16px; padding: 15px; margin-top: 15px; animation: slideDown 0.3s; color: white; }
    
    #password-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center; }
    .pwd-card { background: white; padding: 20px; border-radius: 12px; width: 80%; max-width: 300px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .pwd-title { font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #333; }
    .pwd-input { margin-bottom: 15px; letter-spacing: 3px; font-size: 20px !important; text-align: center; }
    .pwd-btns { display: flex; gap: 8px; }
    .btn-cancel { background: #6c757d; font-size: 15px; height: 45px; }
    .btn-confirm { background: #198754; font-size: 15px; height: 45px; }

    @keyframes slideDown { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
    .dash-title { color: #ffc107; font-weight: bold; text-align: center; margin-bottom: 12px; font-size: 16px; border-bottom: 1px solid #495057; padding-bottom: 8px; }
    
    .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
    .dash-btn { background: #343a40; border: 1px solid #495057; color: #e9ecef; width: 100%; height: 50px; font-size: 13px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; }
    .dash-btn span { font-size: 16px; }
    .dash-btn:active { background: #495057; transform: scale(0.98); }
    .dash-btn-full { grid-column: span 2; background: linear-gradient(135deg, #0d6efd, #0b5ed7); border: none; font-weight: bold; }
    .dash-btn-ceo { grid-column: span 2; background: linear-gradient(135deg, #1A237E, #303F9F); border: 1px solid #FFD700; color: #FFD700; font-weight: 900; }

    #manual-area { display: none; margin-top: 15px; padding: 12px; background: #fff3cd; border: 1px dashed #ffc107; border-radius: 12px; text-align: center; }
    #manual-btn { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; height: 50px; background: linear-gradient(135deg, #198754, #146c43); color: white; text-decoration: none; border-radius: 10px; margin-top: 8px; box-shadow: 0 3px 6px rgba(25, 135, 84, 0.2); }
  </style>
</head>
<body>

<div id="loading-mask"><div class="spinner"></div><div id="loading-text">Loading...</div></div>

<div id="password-modal">
    <div class="pwd-card">
        <div class="pwd-title">ğŸ” Admin Password</div>
        <input type="password" id="admin-pwd" class="pwd-input" placeholder="â€¢â€¢â€¢â€¢" maxlength="4" inputmode="numeric">
        <div class="pwd-btns">
            <button class="btn-cancel" onclick="closePwdModal()"><span class="btn-text-main">Cancel</span></button>
            <button class="btn-confirm" onclick="checkPwd()"><span class="btn-text-main">OK</span></button>
        </div>
    </div>
</div>

<div class="card" id="main-card">
  <h3>ğŸ¥•VDS æ‰“å¡ç³»çµ± v30</h3>
  <span class="sub-title">Há»‡ thá»‘ng cháº¥m cÃ´ng tÃ i xáº¿</span>
  
  <label>ğŸ‘¨ğŸ¼â€ğŸŒ¾ å¸æ©Ÿå§“å <span>(TÃªn tÃ i xáº¿)</span></label>
  <select id="driver" onchange="checkCustomInput('driver')">
    <option value="" disabled selected>è¼‰å…¥ä¸­... (Äang táº£i...)</option>
    <option value="åŠ‰æ–‡ç”Ÿ">åŠ‰æ–‡ç”Ÿ (A Sanh)</option>
    <option value="é˜®è¬ç·´">é˜®è¬ç·´ (Ta Luyá»‡n)</option>
    <option value="éƒ­æ–‡çµ±">éƒ­æ–‡çµ± (VÄƒn Thá»‘ng)</option>
    <option value="æ—å† å®‡">æ—å† å®‡ (QuÃ¡n VÅ©)</option>
    <option value="é™³è¡ä»‹">é™³è¡ä»‹ (A Giá»›i)</option>
    <option value="æ¸¬è©¦">æ¸¬è©¦ (Test)</option>
    <option value="custom">âœï¸ è‡ªè¡Œè¼¸å…¥ (Nháº­p tay...)</option>
  </select>
  <input type="text" id="driver-custom" class="custom-input" placeholder="è¼¸å…¥å§“å (Nháº­p tÃªn)">

  <label>ğŸš› è»Šç‰Œè™Ÿç¢¼ <span>(Biá»ƒn sá»‘ xe)</span></label>
  <select id="plate" onchange="checkCustomInput('plate')">
    <option value="" disabled selected>è«‹é¸æ“‡è»Šç‰Œ... (Chá»n biá»ƒn sá»‘)</option>
    <optgroup label="å…¬å¸è»Šè¼› (Xe cÃ´ng ty)">
        <option value="027-TN">027-TN</option>
        <option value="KEM-9277">KEM-9277</option>
        <option value="KER-1677">KER-1677</option>
        <option value="AAR-227">AAR-227</option>
        <option value="KEN-6977">KEN-6977</option>
    </optgroup>
    <option value="custom">âœï¸ è‡ªè¡Œè¼¸å…¥ (Nháº­p tay...)</option>
  </select>
  <input type="text" id="plate-custom" class="custom-input" placeholder="è¼¸å…¥è»Šç‰Œ (Nháº­p biá»ƒn sá»‘)">

  <label>ğŸ”¢ è¶Ÿæ¬¡ <span>(Sá»‘ chuyáº¿n)</span></label>
  <select id="trip">
    <option value="ç¬¬1è¶Ÿ" selected>ç¬¬1è¶Ÿ (Chuyáº¿n 1)</option>
    <option value="ç¬¬2è¶Ÿ">ç¬¬2è¶Ÿ (Chuyáº¿n 2)</option>
    <option value="ç¬¬3è¶Ÿ">ç¬¬3è¶Ÿ (Chuyáº¿n 3)</option>
    <option value="ç¬¬4è¶Ÿ">ç¬¬4è¶Ÿ (Chuyáº¿n 4)</option>
    <option value="ç¬¬5è¶Ÿ">ç¬¬5è¶Ÿ (Chuyáº¿n 5)</option>
    <option value="ç¬¬6è¶Ÿ">ç¬¬6è¶Ÿ (Chuyáº¿n 6)</option>
    <option value="ç¬¬7è¶Ÿ">ç¬¬7è¶Ÿ (Chuyáº¿n 7)</option>
    <option value="ç¬¬8è¶Ÿ">ç¬¬8è¶Ÿ (Chuyáº¿n 8)</option>
    <option value="ç¬¬9è¶Ÿ">ç¬¬9è¶Ÿ (Chuyáº¿n 9)</option>
    <option value="ç¬¬10è¶Ÿ">ç¬¬10è¶Ÿ (Chuyáº¿n 10)</option>
  </select>

  <div class="divider"></div>

  <label>ğŸ“ ç›®å‰åœ°é» <span>(Vá»‹ trÃ­ hiá»‡n táº¡i)</span></label>
  <select id="location" onchange="checkCustomInput('location')">
    <optgroup label="å¸¸ç”¨åœ°é» (ThÆ°á»ng dÃ¹ng)">
      <option value="å…¬å¸">ğŸ¢ å…¬å¸ (CÃ´ng ty)</option>
      <option value="ç”°é–“">ğŸŒ¾ ç”°é–“ (NgoÃ i Ä‘á»“ng)</option>
    </optgroup>
    <optgroup label="åœ°é»åˆ—è¡¨ (Danh sÃ¡ch)">
      <option value="è¾²å ´æ™ƒæ™ƒ">ğŸŒ¾ è¾²å ´æ™ƒæ™ƒ</option>
      <option value="é¦¬å…‰">ğŸ¥• é¦¬å…‰</option>
      <option value="ä½³ç¾">ğŸ­ ä½³ç¾</option>
      <option value="å…‰æ³‰">ğŸ­ å…‰æ³‰</option>
      <option value="ä¹…æ´¥">ğŸ­ ä¹…æ´¥</option>
      <option value="é”ç¾¤">ğŸ­ é”ç¾¤</option>
      <option value="æ·‘è²">ğŸ™ï¸ æ·‘è²</option>
      <option value="é™³ä¿éœ–">ğŸ™ï¸ é™³ä¿éœ–</option>
      <option value="å³æ·‘ç²">ğŸ™ï¸ å³æ·‘ç²</option>      
      <option value="æ¥Šé´»éš†">ğŸ™ï¸ æ¥Šé´»éš†</option>
      <option value="è¥¿èº">ğŸ™ï¸ è¥¿èº</option>
      <option value="åŒ—æ–—">ğŸ™ï¸ åŒ—æ–—</option>
      <option value="å°ä¸­">ğŸ™ï¸ å°ä¸­</option>
      <option value="æ–—å…­">ğŸ™ï¸ æ–—å…­</option>
      <option value="å˜‰ç¾©">ğŸ™ï¸ å˜‰ç¾©</option>
      <option value="å…ƒé•·">ğŸ™ï¸ å…ƒé•·</option>
      <option value="å°å—">ğŸ™ï¸ å°å—</option>
      <option value="æ–—å—ä¿é¤Šå» ">ğŸ”§ æ–—å—ä¿é¤Šå» </option>
      <option value="èŠ±å£‡ä¿é¤Šå» ">ğŸ”§ èŠ±å£‡ä¿é¤Šå» </option>
      <option value="å°ä¸­æ¸¯">ğŸš¢ å°ä¸­æ¸¯</option>
      <option value="é«˜é›„æ¸¯">ğŸš¢ é«˜é›„æ¸¯</option>
      <option value="æ–°ç¤¾ç¨®è‹—å ´">ğŸŒ± æ–°ç¤¾ç¨®è‹—å ´</option>
    </optgroup>
    <option value="custom">âœï¸ è‡ªè¡Œè¼¸å…¥ (Nháº­p tay...)</option>
  </select>
  <input type="text" id="location-custom" class="custom-input" placeholder="è¼¸å…¥åœ°é» (Nháº­p Ä‘á»‹a Ä‘iá»ƒm)">

  <label id="dest-label">ğŸ é è¨ˆå‰å¾€ <span>(NÆ¡i Ä‘áº¿n dá»± kiáº¿n)</span></label>
  <select id="destination" onchange="checkCustomInput('destination')">
    <option value="" disabled selected>è«‹é¸æ“‡ç›®çš„åœ°... (Chá»n nÆ¡i Ä‘áº¿n)</option>
    <optgroup label="å¸¸ç”¨åœ°é» (ThÆ°á»ng dÃ¹ng)">
      <option value="å…¬å¸">ğŸ¢ å…¬å¸ (CÃ´ng ty)</option>
      <option value="ç”°é–“">ğŸŒ¾ ç”°é–“ (NgoÃ i Ä‘á»“ng)</option>
    </optgroup>
    <optgroup label="åœ°é»åˆ—è¡¨ (Danh sÃ¡ch)">
      <option value="è¾²å ´æ™ƒæ™ƒ">ğŸŒ¾ è¾²å ´æ™ƒæ™ƒ</option>
      <option value="é¦¬å…‰">ğŸ¥• é¦¬å…‰</option>
      <option value="ä½³ç¾">ğŸ­ ä½³ç¾</option>
      <option value="å…‰æ³‰">ğŸ­ å…‰æ³‰</option>
      <option value="ä¹…æ´¥">ğŸ­ ä¹…æ´¥</option>
      <option value="é”ç¾¤">ğŸ­ é”ç¾¤</option>
      <option value="æ·‘è²">ğŸ™ï¸ æ·‘è²</option>
      <option value="é™³ä¿éœ–">ğŸ™ï¸ é™³ä¿éœ–</option>
      <option value="å³æ·‘ç²">ğŸ™ï¸ å³æ·‘ç²</option>      
      <option value="æ¥Šé´»éš†">ğŸ™ï¸ æ¥Šé´»éš†</option>
      <option value="è¥¿èº">ğŸ™ï¸ è¥¿èº</option>
      <option value="åŒ—æ–—">ğŸ™ï¸ åŒ—æ–—</option>
      <option value="å°ä¸­">ğŸ™ï¸ å°ä¸­</option>
      <option value="æ–—å…­">ğŸ™ï¸ æ–—å…­</option>
      <option value="å˜‰ç¾©">ğŸ™ï¸ å˜‰ç¾©</option>
      <option value="å…ƒé•·">ğŸ™ï¸ å…ƒé•·</option>
      <option value="å°å—">ğŸ™ï¸ å°å—</option>
      <option value="æ–—å—ä¿é¤Šå» ">ğŸ”§ æ–—å—ä¿é¤Šå» </option>
      <option value="èŠ±å£‡ä¿é¤Šå» ">ğŸ”§ èŠ±å£‡ä¿é¤Šå» </option>
      <option value="å°ä¸­æ¸¯">ğŸš¢ å°ä¸­æ¸¯</option>
      <option value="é«˜é›„æ¸¯">ğŸš¢ é«˜é›„æ¸¯</option>
      <option value="æ–°ç¤¾ç¨®è‹—å ´">ğŸŒ± æ–°ç¤¾ç¨®è‹—å ´</option>
    </optgroup>
    <option value="custom">âœï¸ è‡ªè¡Œè¼¸å…¥ (Nháº­p tay...)</option>
  </select>
  <input type="text" id="destination-custom" class="custom-input" placeholder="è¼¸å…¥ç›®çš„åœ° (Nháº­p nÆ¡i Ä‘áº¿n)">

  <label>âš™ï¸ ä½œæ¥­/è¶Ÿæ¬¡ <span>(Loáº¡i cÃ´ng viá»‡c)</span></label>
  <div class="radio-group">
    <label class="radio-option"><input type="radio" name="taskType" value="" checked><div class="radio-content"><span class="radio-text-main">å…¶ä»–</span><span class="radio-text-sub">KhÃ¡c</span></div></label>
    <label class="radio-option"><input type="radio" name="taskType" value="æ©Ÿæ¡"><div class="radio-content"><span class="radio-text-main">æ©Ÿæ¡</span><span class="radio-text-sub">MÃ¡y thu</span></div></label>
    <label class="radio-option"><input type="radio" name="taskType" value="äººæ¡"><div class="radio-content"><span class="radio-text-main">äººæ¡</span><span class="radio-text-sub">NgÆ°á»i thu</span></div></label>
  </div>

  <div class="btn-row">
    <button class="btn-go" onclick="processClick('å‡ºè»Š')"><span class="btn-text-main">ğŸš€ å‡ºç™¼/å‡ºè»Š</span><span class="btn-text-sub">Xuáº¥t phÃ¡t</span></button>
    <button class="btn-arrive" onclick="processClick('æŠµé”')"><span class="btn-text-main">ğŸ æŠµé”/å›åˆ°</span><span class="btn-text-sub">Äáº¿n nÆ¡i</span></button>
  </div>
  <button class="btn-end" onclick="processClick('ä½œæ¥­çµæŸ')"><span class="btn-text-main">ğŸ›‘ çµæŸä»Šæ—¥ä½œæ¥­</span><span class="btn-text-sub">Káº¿t thÃºc cÃ´ng viá»‡c</span></button>

  <div id="dashboard-toggle" onclick="openPwdModal()">ğŸ“Š ç®¡ç†å“¡æˆ°æƒ…å®¤ (Admin Dashboard)</div>
  
  <div id="dashboard-panel">
      <div class="dash-title">ğŸš€ VDS æ™ºæ…§æˆ°æƒ…å®¤</div>
      <button class="dash-btn dash-btn-ceo" onclick="sendCmd('ç¸½è£')"><span>ğŸ­</span> ä¼æ¥­ç¸½è£å„€è¡¨æ¿<br>(CEO Dashboard)</button>
      <div class="dash-grid">
          <button class="dash-btn" onclick="sendCmd('æ’è¡Œ')"><span>ğŸ†</span> å¸æ©Ÿæ’è¡Œ</button>
          <button class="dash-btn" onclick="sendCmd('è»Šè¼›')"><span>ğŸš›</span> è»Šè¼›ç¨¼å‹•</button>
          <button class="dash-btn" onclick="sendCmd('æ·±åº¦')"><span>ğŸ“Š</span> æ·±åº¦ç¸¾æ•ˆ</button>
          <button class="dash-btn" onclick="sendCmd('åœ°é»')"><span>ğŸ›‘</span> åœ°é»æ»¯ç•™</button>
      </div>
      <button class="dash-btn dash-btn-full" onclick="sendCmd('å‹•æ…‹')"><span>ğŸ“¡</span> ä»Šæ—¥å³æ™‚å‹•æ…‹ (Live)</button>
      <button class="dash-btn dash-btn-full" onclick="sendCmd('è¶¨å‹¢')"><span>ğŸ“…</span> è¿‘å…©é€±è¶¨å‹¢æ¯”è¼ƒ (Trend)</button>
  </div>

  <div id="status">ç³»çµ±å°±ç·’ v30.0</div>
  <div id="manual-area"><div style="color: #d63384; font-weight: bold; margin-bottom:5px;">âš ï¸ è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç™¼é€</div><a id="manual-btn" href="#" target="_blank"><span style="font-size:18px; font-weight:bold;">ğŸŸ¢ é»æˆ‘ç™¼é€ (Nháº¥n vÃ o Ä‘Ã¢y)</span></a></div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
var LIFF_ID = "2008961063-iwAJvIC3";
var GAS_URL = "https://script.google.com/macros/s/AKfycbzQy_YJgZ7sXj6Y7JgZ7sXj6Y7JgZ7sXj6Y7JgZ7sXj6Y7J/exec"; 
var ADMIN_PWD = "8888"; 

function openPwdModal() {
    var p = document.getElementById('dashboard-panel');
    if(p.style.display === 'block') { p.style.display = 'none'; } 
    else { document.getElementById('password-modal').style.display = 'flex'; document.getElementById('admin-pwd').value = ''; document.getElementById('admin-pwd').focus(); }
}
function closePwdModal() { document.getElementById('password-modal').style.display = 'none'; }
function checkPwd() {
    var input = document.getElementById('admin-pwd').value;
    if (input === ADMIN_PWD) { closePwdModal(); var p = document.getElementById('dashboard-panel'); p.style.display = 'block'; p.scrollIntoView({ behavior: "smooth", block: "center" }); } 
    else { alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼(Sai máº­t kháº©u)"); document.getElementById('admin-pwd').value = ''; }
}

function sendCmd(cmdText) {
    if (!liff.isInClient()) { alert("è«‹åœ¨ LINE ä¸­ä½¿ç”¨æˆ°æƒ…å®¤åŠŸèƒ½"); return; }
    // é€™è£¡æˆ‘å€‘ç›´æ¥å‚³é€æ–‡å­—ï¼Œè§¸ç™¼ Webhook
    var fullCmd = "æˆ°æƒ…å®¤ " + ADMIN_PWD + " " + cmdText;
    
    liff.sendMessages([{ type: 'text', text: fullCmd }]).then(function() {
        alert("ğŸ“Š è«‹æ±‚å·²ç™¼é€ï¼Œè«‹å›åˆ° LINE èŠå¤©å®¤æŸ¥çœ‹å ±è¡¨ï¼\n(ÄÃ£ gá»­i yÃªu cáº§u, vui lÃ²ng kiá»ƒm tra LINE!)");
        liff.closeWindow();
    }).catch(function(error) {
        alert("ç™¼é€å¤±æ•—ï¼š" + error);
    });
}

function checkCustomInput(type) {
    var select = document.getElementById(type); var input = document.getElementById(type + '-custom');
    if (select.value === 'custom') { input.style.display = 'block'; input.focus(); } else { input.style.display = 'none'; input.value = ''; }
}
function toggleButtons(disabled) {
    var btns = document.querySelectorAll('button');
    btns.forEach(function(btn) { if(!btn.classList.contains('dash-btn') && !btn.classList.contains('btn-cancel') && !btn.classList.contains('btn-confirm')) { btn.disabled = disabled; } });
}
window.onload = function() {
  setTimeout(function() { var mask = document.getElementById('loading-mask'); if(mask) mask.style.display = 'none'; }, 2000);
  loadHistory('driver', 'vds_history_driver'); loadHistory('plate', 'vds_history_plate'); loadHistory('location', 'vds_history_loc'); loadHistory('destination', 'vds_history_dest');
  var savedDate = localStorage.getItem('vds_trip_date'); var today = new Date().toDateString(); 
  if (savedDate === today) { var savedTrip = localStorage.getItem('vds_trip_val'); if(savedTrip) document.getElementById('trip').value = savedTrip; } 
  else { localStorage.removeItem('vds_trip_val'); localStorage.removeItem('vds_trip_date'); }
  var lastDest = localStorage.getItem('vds_last_dest');
  if (lastDest) { var locSelect = document.getElementById('location'); var found = false; for(var i=0; i<locSelect.options.length; i++) { if(locSelect.options[i].value === lastDest) { locSelect.selectedIndex = i; found = true; break; } } if(!found) { locSelect.value = 'custom'; document.getElementById('location-custom').value = lastDest; checkCustomInput('location'); } }
  
  liff.init({ liffId: LIFF_ID }).then(function() {
    if (!liff.isLoggedIn()) { liff.login(); return; }
    liff.getProfile().then(function(profile) { 
        updateDriverSelect(profile.displayName); 
        document.getElementById('loading-mask').style.display = 'none'; 
    }).catch(function() { document.getElementById('loading-mask').style.display = 'none'; });
  }).catch(function() { document.getElementById('loading-mask').style.display = 'none'; });
};

function loadHistory(selectId, storageKey) { var history = JSON.parse(localStorage.getItem(storageKey) || '[]'); if (history.length > 0) { var select = document.getElementById(selectId); var group = document.createElement('optgroup'); group.label = "ğŸ•’ æœ€è¿‘è¼¸å…¥ (Gáº§n Ä‘Ã¢y)"; history.reverse().forEach(function(item) { var opt = document.createElement('option'); opt.value = item; opt.text = "ğŸ•’ " + item; group.appendChild(opt); }); select.insertBefore(group, select.firstChild); } }
function saveHistory(val, storageKey) { if(!val) return; var history = JSON.parse(localStorage.getItem(storageKey) || '[]'); var index = history.indexOf(val); if (index > -1) { history.splice(index, 1); } history.push(val); if (history.length > 5) history.shift(); localStorage.setItem(storageKey, JSON.stringify(history)); }
function restoreSelection(elementId, storageKey) { var saved = localStorage.getItem(storageKey); if(saved) { var select = document.getElementById(elementId); for(var i=0; i<select.options.length; i++) { if(select.options[i].value === saved) { select.selectedIndex = i; break; } } } }
function updateDriverSelect(lineName) { var driverSelect = document.getElementById('driver'); var savedDriver = localStorage.getItem('vds_driver'); if (savedDriver) { for (var i = 0; i < driverSelect.options.length; i++) { if (driverSelect.options[i].value === savedDriver) { driverSelect.selectedIndex = i; var statusDiv = document.getElementById('status'); if(statusDiv) statusDiv.innerHTML = "âœ… å·²è­˜åˆ¥: " + savedDriver; restoreSelection('plate', 'vds_plate'); return; } } } }
function sendToSheet(data) { if (GAS_URL.indexOf("xxxx") > -1) { return; } fetch(GAS_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) }); }

function processClick(action) {
  try {
    toggleButtons(true); document.getElementById('loading-mask').style.display = 'flex'; document.getElementById('manual-area').style.display = 'none';
    var driverSelect = document.getElementById('driver'); var driver = driverSelect.value === 'custom' ? document.getElementById('driver-custom').value : driverSelect.value;
    var plateSelect = document.getElementById('plate'); var plate = plateSelect.value === 'custom' ? document.getElementById('plate-custom').value.trim().toUpperCase() : plateSelect.value;
    var trip = document.getElementById('trip').value;
    var locSelect = document.getElementById('location'); var loc = locSelect.value === 'custom' ? document.getElementById('location-custom').value : locSelect.value;
    var destSelect = document.getElementById('destination'); var dest = destSelect.value === 'custom' ? document.getElementById('destination-custom').value : destSelect.value;
    var type = ""; var radios = document.getElementsByName('taskType'); for (var i = 0; i < radios.length; i++) { if (radios[i].checked) { type = radios[i].value; break; } }
    
    if (!driver || driver.trim() === "") { document.getElementById('loading-mask').style.display = 'none'; alert("è«‹é¸æ“‡æˆ–è¼¸å…¥å¸æ©Ÿå§“åï¼\n(Vui lÃ²ng chá»n tÃªn tÃ i xáº¿!)"); toggleButtons(false); if(driverSelect.value === 'custom') document.getElementById('driver-custom').focus(); return; }
    if(driverSelect.value === 'custom') saveHistory(driver, 'vds_history_driver'); localStorage.setItem('vds_driver', driver);
    if (plateSelect.value === 'custom' && plate !== "") saveHistory(plate, 'vds_history_plate'); if (plate) localStorage.setItem('vds_plate', plate);
    var today = new Date().toDateString(); localStorage.setItem('vds_trip_date', today); localStorage.setItem('vds_trip_val', trip);
    if (action === 'å‡ºè»Š') { if(dest) localStorage.setItem('vds_last_dest', dest); } else if (action === 'æŠµé”' || action === 'ä½œæ¥­çµæŸ') { if(loc) localStorage.setItem('vds_last_dest', loc); }
    if (action !== "ä½œæ¥­çµæŸ") { if (!loc || loc.trim() === "") { document.getElementById('loading-mask').style.display = 'none'; alert("è«‹è¼¸å…¥ã€Œç›®å‰åœ°é»ã€ï¼\n(Vui lÃ²ng nháº­p vá»‹ trÃ­ hiá»‡n táº¡i!)"); toggleButtons(false); if(locSelect.value === 'custom') document.getElementById('location-custom').focus(); return; } if(locSelect.value === 'custom') saveHistory(loc, 'vds_history_loc'); }
    
    var lastAction = localStorage.getItem('vds_last_status_' + driver); 
    if (action === 'å‡ºè»Š' && lastAction === 'å‡ºè»Š') {
        if (!confirm("âš ï¸ è­¦å‘Šï¼šæ‚¨ä¸Šä¸€ç­†ä¹Ÿæ˜¯ã€Œå‡ºç™¼ã€ï¼\n(Cáº£nh bÃ¡o: Láº§n trÆ°á»›c báº¡n Ä‘Ã£ báº¥m 'Xuáº¥t phÃ¡t'!)\n\nç³»çµ±åµæ¸¬åˆ°æ‚¨å¯èƒ½å¿˜è¨˜æŒ‰ã€ŒæŠµé”ã€äº†ã€‚\n\næŒ‰ã€Œç¢ºå®šã€å¼·åˆ¶å‡ºç™¼ (Tiáº¿p tá»¥c)\næŒ‰ã€Œå–æ¶ˆã€è¿”å›æª¢æŸ¥ (Há»§y)")) {
            document.getElementById('loading-mask').style.display = 'none';
            toggleButtons(false);
            return; 
        }
    }
    if (action === 'å‡ºè»Š') localStorage.setItem('vds_last_status_' + driver, 'å‡ºè»Š');
    else if (action === 'æŠµé”') localStorage.setItem('vds_last_status_' + driver, 'æŠµé”');
    else if (action === 'ä½œæ¥­çµæŸ') localStorage.setItem('vds_last_status_' + driver, 'çµæŸ');

    var now = new Date(); var hh = now.getHours().toString().padStart(2, '0'); var mm = now.getMinutes().toString().padStart(2, '0'); var timeStr = hh + ":" + mm; var plateStr = (plate) ? "[" + plate + "] " : ""; var taskSuffix = (type === "") ? "" : "(" + type + ")"; var msg = "";
    
    if (action === "ä½œæ¥­çµæŸ") { msg = plateStr + driver + " çµæŸæ™‚é–“" + timeStr; } 
    else if (action === "å‡ºè»Š") { 
        if (!dest || dest.trim() === "") { document.getElementById('loading-mask').style.display = 'none'; alert("âš ï¸ è«‹é¸æ“‡æˆ–è¼¸å…¥ã€Œé è¨ˆå‰å¾€ã€çš„ç›®çš„åœ°ï¼\n(Vui lÃ²ng chá»n nÆ¡i Ä‘áº¿n!)"); toggleButtons(false); if(destSelect.value === 'custom') { document.getElementById('destination-custom').focus(); } else { document.getElementById('destination').focus(); } return; } 
        if(destSelect.value === 'custom') saveHistory(dest, 'vds_history_dest'); 
        msg = plateStr + driver + " " + trip + " " + loc + "å‡ºç™¼å‰å¾€" + dest + taskSuffix + " " + timeStr; 
    } 
    else if (action === "æŠµé”") { 
        if (loc === "å…¬å¸") { msg = driver + " å›åˆ°å…¬å¸ " + timeStr; } 
        else { msg = driver + " æŠµé”" + loc + " " + timeStr; } 
    }
    
    sendToSheet({ driver: driver, plate: plate, trip: trip, location: loc, destination: (action === 'å‡ºè»Š') ? dest : "", taskType: type, action: action });
    tryAutoSend(msg);
  } catch (e) { alert("Error: " + e.message); document.getElementById('loading-mask').style.display = 'none'; toggleButtons(false); }
}

function tryAutoSend(msg) { 
    if (!liff.isInClient()) { showManualButton(msg); return; } 
    liff.sendMessages([{ type: 'text', text: msg }]).then(function() { 
        document.getElementById('loading-mask').style.display = 'none'; liff.closeWindow(); 
    }).catch(function(err) { 
        if (liff.isApiAvailable('shareTargetPicker')) { 
            liff.shareTargetPicker([{ type: "text", text: msg }]).then(function(res) { 
                document.getElementById('loading-mask').style.display = 'none'; 
                if (res) liff.closeWindow(); else toggleButtons(false); 
            }).catch(function() { showManualButton(msg); }); 
        } else { showManualButton(msg); } 
    }); 
}

function showManualButton(msg) { 
    document.getElementById('loading-mask').style.display = 'none'; 
    var area = document.getElementById('manual-area'); 
    var btn = document.getElementById('manual-btn'); 
    btn.href = "https://line.me/R/msg/text/?" + encodeURIComponent(msg); 
    area.style.display = 'block'; 
    setTimeout(function() { area.scrollIntoView({ behavior: "smooth", block: "center" }); }, 100); 
}
</script>
</body>
</html>
