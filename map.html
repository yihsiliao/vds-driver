<!DOCTYPE html>
<html>
<head>
  <title>å¸æ©Ÿå³æ™‚åˆ†å¸ƒåœ°åœ–</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <style>
    body { padding: 0; margin: 0; }
    html, body, #map { height: 100%; width: 100vw; }
    
    /* å¸æ©Ÿåå­—æ¨™ç±¤ */
    .driver-label { 
      background: rgba(255, 255, 255, 0.95); 
      border: 1px solid #333; 
      padding: 2px 6px; 
      border-radius: 4px; 
      white-space: nowrap; 
      font-weight: bold; 
      font-size: 13px;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    /* è¼‰å…¥ç•«é¢ */
    #loading {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.9); z-index: 9999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      font-size: 18px; font-weight: bold; color: #444;
    }
  </style>
</head>
<body>
  
  <div id="loading">
    <div>ğŸš€ æ­£åœ¨é€£ç·šæˆ°æƒ…å®¤è³‡æ–™åº«...</div>
    <div style="font-size:12px; font-weight:normal; margin-top:8px; color:#666;">è®€å–ç”°åœ°èˆ‡å¸æ©Ÿä½ç½®</div>
  </div>

  <div id="map"></div>

  <script>
    // 1. åˆå§‹åŒ–åœ°åœ–
    var map = L.map('map'); 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    var globalLocations = []; 

    // ==================================================
    // â˜…â˜…â˜… è¨­å®šå€ï¼šè«‹å¡«å…¥æ‚¨çš„ Google Apps Script ç¶²å€ â˜…â˜…â˜…
    // ==================================================
    // ç¶²å€çµå°¾æ‡‰è©²æ˜¯ /exec
    var GAS_API_URL = "https://script.google.com/macros/s/AKfycbybtZU09KAsnuTPVLz2qTFDfIWs64pNMo3ljSdeSfRAdz_sefe-H2jRlJIR1Xze0xBu/exec";

    // ==================================================
    // æµç¨‹ Aï¼šé€é API æŠ“ç”°åœ°è³‡æ–™
    // ==================================================
    
    // ä½¿ç”¨ fetch å–ä»£ google.script.run
    fetch(GAS_API_URL + "?op=fields")
        .then(response => response.json()) // è§£æ JSON
        .then(data => initLocations(data)) // åŸ·è¡Œå¾ŒçºŒå‹•ä½œ
        .catch(error => console.error('Error fetching fields:', error));

    function initLocations(data) {
       var featureGroup = L.featureGroup(); // ç”¨ä¾†èª¿æ•´è¦–è§’

       data.forEach(function(item) {
           var pairs = item.coords.split(';'); // æª¢æŸ¥æœ‰å¹¾çµ„åº§æ¨™
           var latlngs = [];

           pairs.forEach(function(pair) {
               var xy = pair.split(',');
               if (xy.length === 2) {
                   latlngs.push([parseFloat(xy[0]), parseFloat(xy[1])]);
               }
           });

           if (latlngs.length === 0) return;

           // --- åˆ¤æ–·æ˜¯å–®é»é‚„æ˜¯å¤šé‚Šå½¢ ---
           if (latlngs.length === 1) {
               // ã€å–®é»ã€‘å…¬å¸ã€å·¥å»  -> ç•«è—è‰²åœ“é»
               var center = latlngs[0];
               var circle = L.circleMarker(center, {
                   color: '#1976D2', radius: 5, weight: 1, fillOpacity: 0.8, fillColor: '#1976D2'
               }).bindPopup("<b>ğŸ“ " + item.info + "</b>");
               
               featureGroup.addLayer(circle);
               
               globalLocations.push({ name: item.info, type: 'point', center: center });

           } else {
               // ã€å¤šé‚Šå½¢ã€‘ç”°åœ° -> ç•«æ©˜è‰²å€å¡Š
               var displayInfo = item.info.replace(/\//g, '<br>'); // æ›è¡Œé¡¯ç¤º
               var poly = L.polygon(latlngs, {
                   color: '#FF9800', weight: 1, fillColor: '#FF9800', fillOpacity: 0.2
               }).bindPopup("<div style='text-align:center; font-weight:bold;'>" + displayInfo + "</div>");
               
               featureGroup.addLayer(poly);
               
               globalLocations.push({ name: item.info, type: 'polygon', bounds: poly.getBounds() });
           }
       });

       featureGroup.addTo(map);
       
       // è‡ªå‹•èª¿æ•´åœ°åœ–è¦–è§’ï¼Œæ¶µè“‹æ‰€æœ‰åœ°é»
       if (globalLocations.length > 0) {
           map.fitBounds(featureGroup.getBounds());
       } else {
           map.setView([23.80, 120.35], 13); // é è¨­è¦–è§’
       }

       // éš±è—è¼‰å…¥ç•«é¢
       document.getElementById('loading').style.display = 'none';

       // ============================================
       // æµç¨‹ Bï¼šåœ°é»ç•«å¥½å¾Œï¼Œé–‹å§‹æŠ“å¸æ©Ÿä½ç½®
       // ============================================
       google.script.run.withSuccessHandler(drawMarkers).getLatestDriverStatus();
    }

    function drawMarkers(drivers) {
      drivers.forEach(function(d) {
        var latlng = [0, 0];
        var matched = false;

        // --- æ™ºæ…§æœå°‹æ¼”ç®—æ³• ---
        // 1. å…ˆæ‰¾åå­—æœ‰å°ä¸Šçš„ (ä¾‹å¦‚å¸æ©Ÿåœ¨ "A001"ï¼Œè³‡æ–™åº«æœ‰ "A001")
        var candidates = globalLocations.filter(function(loc) {
            return d.loc.indexOf(loc.name) !== -1 || loc.name.indexOf(d.loc) !== -1;
        });

        // 2. å¦‚æœæ‰¾ä¸åˆ°ï¼Œä½†åœ°é»åŒ…å« "ç”°"ï¼Œå°±éš¨æ©Ÿæ‰¾ä¸€å¡Šç”°æ”¾ (è¦–è¦ºæ¨¡æ“¬)
        if (candidates.length === 0 && d.loc.includes("ç”°")) {
             candidates = globalLocations.filter(function(loc) { return loc.type === 'polygon'; });
        }

        // 3. æ±ºå®šæœ€çµ‚åº§æ¨™
        if (candidates.length > 0) {
            // éš¨æ©Ÿé¸ä¸€å€‹ç¬¦åˆçš„ (é¿å…å¤šäººé‡ç–Š)
            var target = candidates[Math.floor(Math.random() * candidates.length)];
            
            if (target.type === 'polygon') {
                // å¦‚æœæ˜¯ç”°ï¼šåœ¨ç”°çš„ç¯„åœå…§éš¨æ©Ÿé¡¯ç¤º
                var bounds = target.bounds;
                var lat = bounds.getSouth() + Math.random() * (bounds.getNorth() - bounds.getSouth());
                var lng = bounds.getWest() + Math.random() * (bounds.getEast() - bounds.getWest());
                latlng = [lat, lng];
            } else {
                // å¦‚æœæ˜¯å–®é» (å…¬å¸)ï¼šåœ¨ä¸­å¿ƒé»é™„è¿‘å¾®èª¿ (é¿å…é‡ç–Š)
                latlng = target.center.slice();
                latlng[0] += (Math.random() - 0.5) * 0.0005; 
                latlng[1] += (Math.random() - 0.5) * 0.0005;
            }
            matched = true;
        } 
        
        // 4. å®Œå…¨æ‰¾ä¸åˆ° (ä¾‹å¦‚: åŠ æ²¹ç«™)ï¼Œå°±æ”¾åœ¨åœ°åœ–ä¸­å¿ƒé™„è¿‘ç•¶ä½œ "æœªçŸ¥"
        if (!matched) {
            var center = map.getCenter();
            latlng = [center.lat + (Math.random()-0.5)*0.01, center.lng + (Math.random()-0.5)*0.01];
        }

        // --- ç¹ªè£½å¸æ©Ÿåœ–æ¨™ ---
        var color = d.status.includes("å‡ºç™¼") ? "#2E7D32" : "#D32F2F"; // ç¶ (å‡ºç™¼) / ç´…(æŠµé”)
        
        // å¸¶æœ‰å…‰æšˆçš„åœ“é»
        var iconHtml = `<div style="
            background-color:${color}; 
            width:14px; height:14px; 
            border-radius:50%; 
            border:2px solid white; 
            box-shadow: 0 0 8px ${color};">
        </div>`;
        
        var customIcon = L.divIcon({ className: 'custom-pin', html: iconHtml, iconSize: [18, 18], iconAnchor: [9, 9] });

        var marker = L.marker(latlng, {icon: customIcon}).addTo(map);
        
        // å½ˆå‡ºè¦–çª—å…§å®¹
        var popupContent = `
            <div style="text-align:center;">
                <b style="font-size:15px;">${d.driver}</b><br>
                <span style="color:#555; font-size:12px;">ğŸ“ ${d.loc}</span><br>
                <span style="color:${color}; font-weight:bold;">${d.status}</span><br>
                <small style="color:#888;">ğŸ•’ ${d.time}</small>
            </div>`;
        
        marker.bindPopup(popupContent);
        // æ°¸é é¡¯ç¤ºå¸æ©Ÿåå­—
        marker.bindTooltip(d.driver, {permanent: true, direction: "top", className: "driver-label"}).openTooltip();
      });
    }
  </script>
</body>
</html>
