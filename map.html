<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ğŸ¥• VDS å¸æ©Ÿæˆ°æƒ…åœ°åœ–</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { padding: 0; margin: 0; font-family: "Microsoft JhengHei", sans-serif; }
    html, body, #map { height: 100%; width: 100vw; background: #e0e0e0; }
    
    /* å¸æ©Ÿæ¨™ç±¤æ¨£å¼ */
    .driver-label { 
      background: rgba(255, 255, 255, 0.95); 
      border: 1px solid #666; 
      padding: 2px 6px; 
      border-radius: 4px; 
      white-space: nowrap; 
      font-weight: bold; 
      font-size: 13px;
      color: #333;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    }
    
    /* è¼‰å…¥ä¸­é®ç½© */
    #loading {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.95); z-index: 9999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      transition: opacity 0.5s;
    }
    .spinner {
      border: 5px solid #f3f3f3; border-top: 5px solid #2E7D32;
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite; margin-bottom: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loading">
    <div class="spinner"></div>
    <div style="font-size:18px; font-weight:bold; color:#333;">æ­£åœ¨é€£ç·šæˆ°æƒ…å®¤...</div>
    <div style="font-size:12px; color:#666; margin-top:5px;">è®€å–ç”°åœ°è³‡æ–™åº« & å¸æ©Ÿä½ç½®</div>
  </div>

  <div id="map"></div>

  <script>
    // =========================================================
    // â˜…â˜…â˜… è¨­å®šå€ï¼šè«‹å‹™å¿…ä¿®æ”¹é€™è£¡ â˜…â˜…â˜…
    // =========================================================
    // è«‹å¡«å…¥æ‚¨å‰›å‰›éƒ¨ç½² GAS å¾Œå–å¾—çš„ç¶²å€ (çµå°¾æ˜¯ /exec)
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyD0PoIElZYUiD8Es8Jzo9cft4gKYWIWtM-ejjED3UQJcv8YwyF7SbhaPRajqyC0WsQ/exec";
    // =========================================================

    // 1. åˆå§‹åŒ–åœ°åœ– (é è¨­ä¸­å¿ƒï¼šé›²æ—/å½°åŒ–ä¸€å¸¶)
    var map = L.map('map', { zoomControl: false }).setView([23.85, 120.45], 12);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // ä½¿ç”¨ OpenStreetMap åœ–å±¤
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap | VDS Logistics',
      maxZoom: 19
    }).addTo(map);

    // å…¨åŸŸè®Šæ•¸
    var globalLocations = []; // å­˜åœ°é» (ç”°+å…¬å¸)
    var driverMarkers = [];   // å­˜å¸æ©Ÿæ¨™è¨˜

    // 2. å•Ÿå‹•æµç¨‹ï¼šå…ˆæŠ“åœ°åœ–è³‡æ–™ -> å†æŠ“å¸æ©Ÿ
    fetchFields();

    function fetchFields() {
        // å‘¼å« API: ?op=fields
        fetch(GAS_API_URL + "?op=fields")
        .then(response => response.json())
        .then(data => {
            renderLocations(data);
            fetchDrivers(); // åœ°é»ç•«å®Œå¾Œï¼Œæ¥è‘—æŠ“å¸æ©Ÿ
        })
        .catch(err => {
            console.error(err);
            document.getElementById('loading').innerHTML = "<div style='color:red'>é€£ç·šå¤±æ•—<br>è«‹ç¢ºèª API ç¶²å€æ¬Šé™</div>";
        });
    }

    function renderLocations(data) {
        var featureGroup = L.featureGroup();

        data.forEach(item => {
            if(!item.coords) return;
            
            // åˆ¤æ–·åº§æ¨™æ ¼å¼ (åˆ†è™Ÿä»£è¡¨å¤šé‚Šå½¢)
            var pairs = item.coords.split(';');
            var latlngs = [];
            
            pairs.forEach(p => {
                var xy = p.split(',');
                if(xy.length === 2) latlngs.push([parseFloat(xy[0]), parseFloat(xy[1])]);
            });

            if (latlngs.length === 0) return;

            // A. å–®é» (å…¬å¸/å·¥å» )
            if (latlngs.length === 1) {
                var center = latlngs[0];
                L.circleMarker(center, {
                    color: '#1565C0', radius: 6, weight: 1, fillOpacity: 0.6, fillColor: '#1565C0'
                }).bindPopup(`<b>ğŸ¢ ${item.info}</b>`).addTo(featureGroup);

                globalLocations.push({ name: item.info, type: 'point', center: center });
            } 
            // B. å¤šé‚Šå½¢ (ç”°åœ°)
            else {
                var poly = L.polygon(latlngs, {
                    color: '#FF9800', weight: 1, fillColor: '#FF9800', fillOpacity: 0.15
                }).bindPopup(`<b>ğŸŒ¾ ${item.info}</b>`);
                
                featureGroup.addLayer(poly);
                globalLocations.push({ name: item.info, type: 'polygon', bounds: poly.getBounds() });
            }
        });

        featureGroup.addTo(map);
        
        // è‡ªå‹•èª¿æ•´è¦–è§’ä»¥æ¶µè“‹æ‰€æœ‰åœ°é»
        if(globalLocations.length > 0) {
            map.fitBounds(featureGroup.getBounds(), { padding: [20, 20] });
        }
    }

    function fetchDrivers() {
        // å‘¼å« API: ?op=drivers
        fetch(GAS_API_URL + "?op=drivers")
        .then(response => response.json())
        .then(drivers => {
            updateDriverMarkers(drivers);
            document.getElementById('loading').style.opacity = 0;
            setTimeout(() => { document.getElementById('loading').style.display = 'none'; }, 500);
        })
        .catch(err => console.error("ç„¡æ³•è®€å–å¸æ©Ÿ:", err));
    }

    function updateDriverMarkers(drivers) {
        // æ¸…é™¤èˆŠæ¨™è¨˜ (å¦‚æœè¦åšè‡ªå‹•åˆ·æ–°åŠŸèƒ½çš„è©±)
        // driverMarkers.forEach(m => map.removeLayer(m));
        
        drivers.forEach(d => {
            var latlng = getSmartPosition(d.loc);
            
            // æ±ºå®šé¡è‰²ï¼šå‡ºç™¼=ç¶ ï¼ŒæŠµé”=ç´…
            var color = d.status.includes("å‡ºç™¼") ? "#2E7D32" : "#D32F2F"; 
            var statusIcon = d.status.includes("å‡ºç™¼") ? "ğŸšš" : "ğŸ›‘";

            // è£½ä½œæ¼‚äº®çš„åœ“é»åœ–æ¨™
            var iconHtml = `<div style="
                background-color: ${color};
                width: 16px; height: 16px;
                border-radius: 50%;
                border: 2px solid white;
                box-shadow: 0 0 8px ${color};">
            </div>`;

            var customIcon = L.divIcon({
                className: 'custom-pin',
                html: iconHtml,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            var marker = L.marker(latlng, { icon: customIcon }).addTo(map);
            
            // æ°£æ³¡å…§å®¹
            var popupContent = `
                <div style="text-align:center; min-width:120px;">
                    <b style="font-size:16px;">${d.driver}</b><br>
                    <span style="color:#555; font-size:12px;">ğŸ“ ${d.loc}</span><br>
                    <hr style="margin:5px 0; border:0; border-top:1px solid #eee;">
                    <span style="color:${color}; font-weight:bold;">${statusIcon} ${d.status}</span><br>
                    <small style="color:#888;">ğŸ•’ ${d.time}</small>
                </div>
            `;

            marker.bindPopup(popupContent);
            marker.bindTooltip(d.driver, { permanent: true, direction: "top", className: "driver-label", offset: [0, -10] }).openTooltip();
            
            driverMarkers.push(marker);
        });
    }

    // â˜…â˜…â˜… æ ¸å¿ƒæ¼”ç®—æ³•ï¼šæ±ºå®šå¸æ©Ÿåœ¨åœ°åœ–ä¸Šçš„ä½ç½® â˜…â˜…â˜…
    function getSmartPosition(locName) {
        // 1. å…ˆæ‰¾æœ‰æ²’æœ‰å®Œå…¨ç¬¦åˆåç¨±çš„åœ°é» (ä¾‹å¦‚ "å…¬å¸")
        var exactMatch = globalLocations.find(l => locName.includes(l.name));
        
        // 2. å¦‚æœæ˜¯ã€Œç”°é–“ã€ï¼Œå¾æ‰€æœ‰ç”°åœ°ä¸­éš¨æ©ŸæŒ‘ä¸€å¡Š (æ¨¡æ“¬åˆ†ä½ˆ)
        // æœªä¾†å¦‚æœè³‡æ–™åº«æœ‰åˆ† Aå€/Bå€ï¼Œé€™è£¡å¯ä»¥åŠ å¼·ç¯©é¸é‚è¼¯
        if (!exactMatch && locName.includes("ç”°")) {
            var fields = globalLocations.filter(l => l.type === 'polygon');
            if (fields.length > 0) {
                exactMatch = fields[Math.floor(Math.random() * fields.length)];
            }
        }

        // 3. è¨ˆç®—åº§æ¨™
        if (exactMatch) {
            if (exactMatch.type === 'polygon') {
                // å¦‚æœæ˜¯ç”°ï¼Œéš¨æ©Ÿå–ç¯„åœå…§çš„ä¸€é»
                var bounds = exactMatch.bounds;
                var lat = bounds.getSouth() + Math.random() * (bounds.getNorth() - bounds.getSouth());
                var lng = bounds.getWest() + Math.random() * (bounds.getEast() - bounds.getWest());
                return [lat, lng];
            } else {
                // å¦‚æœæ˜¯å–®é» (å…¬å¸)ï¼ŒåŠ ä¸€é»éš¨æ©Ÿåç§»ä»¥å…é‡ç–Š
                return [
                    exactMatch.center[0] + (Math.random() - 0.5) * 0.0005,
                    exactMatch.center[1] + (Math.random() - 0.5) * 0.0005
                ];
            }
        }

        // 4. çœŸçš„æ‰¾ä¸åˆ°ï¼Œå›å‚³åœ°åœ–ä¸­å¿ƒ (æœªçŸ¥)
        var center = map.getCenter();
        return [center.lat, center.lng];
    }

    // æ¯ 60 ç§’è‡ªå‹•åˆ·æ–°ä¸€æ¬¡ä½ç½®
    setInterval(fetchDrivers, 60000);

  </script>
</body>
</html>
